<div class="argent-grid-container" [style.height]="height" [style.width]="width" (click)="onContainerClick($event)">
  <div class="argent-grid-main-layout" cdkDropListGroup>
    <div class="argent-grid-content-area">
      <!-- Row Group Panel -->
      <div class="argent-grid-row-group-panel" 
           cdkDropList
           id="row-group-panel"
           cdkDropListOrientation="horizontal"
           (cdkDropListDropped)="onRowGroupDropped($event)">
        <div class="row-group-placeholder" *ngIf="getRowGroupColumns().length === 0">
          Drag columns here to group
        </div>
        <div *ngFor="let col of getRowGroupColumns()" class="row-group-pill">
          <span class="pill-text">{{ getHeaderName(col) }}</span>
          <span class="pill-close" (click)="removeRowGroup(col)">âœ•</span>
        </div>
      </div>

      <!-- Header Layer (DOM-based for accessibility) -->
      <div class="argent-grid-header">
        
        <div class="argent-grid-header-main">
          <!-- Left Pinned Header -->
          <div class="argent-grid-header-pinned-left-container"
               *ngIf="getLeftPinnedColumns().length > 0"
               [style.display]="'grid'"
               [style.grid-template-rows]="'repeat(' + gridApi.getHeaderDepth() + ', ' + rowHeight + 'px)'"
               [style.grid-template-columns]="getGridTemplateColumns('left')"
               cdkDropList
               id="left-pinned-list"
               cdkDropListOrientation="horizontal"
               (cdkDropListDropped)="onColumnDropped($event, 'left')">
            
            <ng-container *ngFor="let entry of getSectionHeaderItems('left'); trackBy: trackByHeaderItem">
              <div
                *ngIf="isColumnVisible(entry.item)"
                class="argent-grid-header-cell argent-grid-header-cell-pinned-left"
                [class.argent-grid-header-group-cell]="isColumnGroup(entry.item)"
                [class.center-content]="!isColumnGroup(entry.item) && entry.item.colId === 'ag-Grid-SelectionColumn'"
                [style.grid-column]="getLeftPinnedColIndex(entry.item) + ' / span ' + getItemColSpan(entry.item)"
                [style.grid-row]="(entry.rowIndex + 1) + ' / span ' + getItemRowSpan(entry.item, entry.rowIndex)"
                [style.width.px]="getItemWidth(entry.item)"
                [style.height.px]="getItemRowSpan(entry.item, entry.rowIndex) * rowHeight"
                [class.sortable]="!isColumnGroup(entry.item) && isSortable(entry.item)"
                (click)="!isColumnGroup(entry.item) && onHeaderClick(entry.item)"
                cdkDrag
                [cdkDragDisabled]="isColumnGroup(entry.item) || entry.item.colId === 'ag-Grid-SelectionColumn'"
                [cdkDragData]="entry.item">
                <div class="argent-grid-header-content" cdkDragHandle>
                  <div *ngIf="!isColumnGroup(entry.item) && hasHeaderCheckbox(entry.item)" class="argent-grid-header-checkbox">
                    <input type="checkbox"
                           [checked]="isAllSelected"
                           [indeterminate]="isIndeterminateSelection"
                           (click)="$event.stopPropagation()"
                           (change)="onSelectionHeaderChange($event)" />
                  </div>
                  <span class="header-text">{{ getHeaderName(entry.item) }}</span>
                  <span class="group-toggle" *ngIf="isColumnGroup(entry.item) && hasExpansionToggle(entry.item)" (click)="toggleGroup(entry.item, $event)">
                     {{ entry.item.expanded ? 'âˆ’' : '+' }}
                  </span>
                  <span class="sort-indicator" *ngIf="!isColumnGroup(entry.item) && getSortIndicator(entry.item)">{{ getSortIndicator(entry.item) }}</span>
                </div>
                <div class="argent-grid-header-menu-icon" (click)="onHeaderMenuClick($event, entry.item)" *ngIf="!isColumnGroup(entry.item) && hasHeaderMenu(entry.item)">
                  &#8942;
                </div>
                <div class="argent-grid-header-resize-handle" 
                     *ngIf="isResizable(entry.item)" 
                     [class.resizing]="isResizing && resizeItem === entry.item"
                     (mousedown)="onResizeMouseDown($event, entry.item)">
                </div>
              </div>
            </ng-container>
          </div>
          
          <!-- Scrollable Header -->
          <div class="argent-grid-header-scrollable" #headerScrollable>
            <div class="argent-grid-header-scrollable-content"
                 [style.display]="'grid'"
                 [style.grid-template-rows]="'repeat(' + gridApi.getHeaderDepth() + ', ' + rowHeight + 'px)'"
                 [style.grid-template-columns]="getGridTemplateColumns('none')"
                 [style.width.px]="getScrollableHeaderWidth()"
                 cdkDropList
                 id="scrollable-list"
                 cdkDropListOrientation="horizontal"
                 (cdkDropListDropped)="onColumnDropped($event, 'none')">
              
              <ng-container *ngFor="let entry of getSectionHeaderItems('none'); trackBy: trackByHeaderItem">
                <div
                  *ngIf="isColumnVisible(entry.item)"
                  class="argent-grid-header-cell"
                  [class.argent-grid-header-group-cell]="isColumnGroup(entry.item)"
                  [style.grid-column]="getScrollableColIndex(entry.item) + ' / span ' + getItemColSpan(entry.item)"
                  [style.grid-row]="(entry.rowIndex + 1) + ' / span ' + getItemRowSpan(entry.item, entry.rowIndex)"
                  [style.width.px]="getItemWidth(entry.item)"
                  [style.height.px]="getItemRowSpan(entry.item, entry.rowIndex) * rowHeight"
                  [class.sortable]="!isColumnGroup(entry.item) && isSortable(entry.item)"
                  (click)="!isColumnGroup(entry.item) && onHeaderClick(entry.item)"
                  cdkDrag
                  [cdkDragDisabled]="isColumnGroup(entry.item) || entry.item.colId === 'ag-Grid-SelectionColumn'"
                  [cdkDragData]="entry.item">
                  <div class="argent-grid-header-content" cdkDragHandle>
                    <span class="header-text">{{ getHeaderName(entry.item) }}</span>
                    <span class="group-toggle" *ngIf="isColumnGroup(entry.item) && hasExpansionToggle(entry.item)" (click)="toggleGroup(entry.item, $event)">
                       {{ entry.item.expanded ? 'âˆ’' : '+' }}
                    </span>
                    <span class="sort-indicator" *ngIf="!isColumnGroup(entry.item) && getSortIndicator(entry.item)">{{ getSortIndicator(entry.item) }}</span>
                  </div>
                  <div class="argent-grid-header-menu-icon" (click)="onHeaderMenuClick($event, entry.item)" *ngIf="!isColumnGroup(entry.item) && hasHeaderMenu(entry.item)">
                    &#8942;
                  </div>
                  <div class="argent-grid-header-resize-handle" 
                       *ngIf="isResizable(entry.item)" 
                       [class.resizing]="isResizing && resizeItem === entry.item"
                       (mousedown)="onResizeMouseDown($event, entry.item)">
                  </div>
                </div>
              </ng-container>
            </div>
          </div>
          
          <!-- Right Pinned Header -->
          <div class="argent-grid-header-pinned-right-container"
               *ngIf="getRightPinnedColumns().length > 0"
               [style.display]="'grid'"
               [style.grid-template-rows]="'repeat(' + gridApi.getHeaderDepth() + ', ' + rowHeight + 'px)'"
               [style.grid-template-columns]="getGridTemplateColumns('right')"
               cdkDropList
               id="right-pinned-list"
               cdkDropListOrientation="horizontal"
               (cdkDropListDropped)="onColumnDropped($event, 'right')">
            
            <ng-container *ngFor="let entry of getSectionHeaderItems('right'); trackBy: trackByHeaderItem">
              <div
                *ngIf="isColumnVisible(entry.item)"
                class="argent-grid-header-cell argent-grid-header-cell-pinned-right"
                [class.argent-grid-header-group-cell]="isColumnGroup(entry.item)"
                [style.grid-column]="getRightPinnedColIndex(entry.item) + ' / span ' + getItemColSpan(entry.item)"
                [style.grid-row]="(entry.rowIndex + 1) + ' / span ' + getItemRowSpan(entry.item, entry.rowIndex)"
                [style.width.px]="getItemWidth(entry.item)"
                [style.height.px]="getItemRowSpan(entry.item, entry.rowIndex) * rowHeight"
                [class.sortable]="!isColumnGroup(entry.item) && isSortable(entry.item)"
                (click)="!isColumnGroup(entry.item) && onHeaderClick(entry.item)"
                cdkDrag
                [cdkDragDisabled]="isColumnGroup(entry.item) || entry.item.colId === 'ag-Grid-SelectionColumn'"
                [cdkDragData]="entry.item">
                <div class="argent-grid-header-content" cdkDragHandle>
                  <span class="header-text">{{ getHeaderName(entry.item) }}</span>
                  <span class="group-toggle" *ngIf="isColumnGroup(entry.item) && hasExpansionToggle(entry.item)" (click)="toggleGroup(entry.item, $event)">
                     {{ entry.item.expanded ? 'âˆ’' : '+' }}
                  </span>
                  <span class="sort-indicator" *ngIf="!isColumnGroup(entry.item) && getSortIndicator(entry.item)">{{ getSortIndicator(entry.item) }}</span>
                </div>
                <div class="argent-grid-header-menu-icon" (click)="onHeaderMenuClick($event, entry.item)" *ngIf="!isColumnGroup(entry.item) && hasHeaderMenu(entry.item)">
                  &#8942;
                </div>
                <div class="argent-grid-header-resize-handle" 
                     *ngIf="isResizable(entry.item)" 
                     [class.resizing]="isResizing && resizeItem === entry.item"
                     (mousedown)="onResizeMouseDown($event, entry.item)">
                </div>
              </div>
            </ng-container>
          </div>

          <!-- Vertical Scrollbar Spacer -->
          <div class="argent-grid-header-scrollbar-spacer" 
               *ngIf="scrollbarWidth > 0"
               [style.width.px]="scrollbarWidth">
          </div>
        </div>

        <!-- Floating Filter Row -->
        <div class="floating-filter-row" *ngIf="hasFloatingFilters()">
          <!-- Left Pinned Filters -->
          <div class="argent-grid-header-pinned-left-container" *ngIf="getLeftPinnedColumns().length > 0">
            <ng-container *ngFor="let col of getLeftPinnedColumns()">
              <div *ngIf="isColumnVisible(col)"
                   class="argent-grid-floating-filter-cell"
                   [style.width.px]="getItemWidth(col)">
                <div class="floating-filter-container" *ngIf="isFloatingFilterEnabled(col)">
                  <input #filterInput
                         class="floating-filter-input"
                         [type]="getFilterInputType(col)"
                         [value]="getFloatingFilterValue(col)"
                         (input)="onFloatingFilterInput($event, col)"
                         [placeholder]="'Filter...'" />
                  <span class="floating-filter-clear" 
                        *ngIf="hasFilterValue(col, filterInput)"
                        (click)="clearFloatingFilter(col, filterInput)">âœ•</span>
                </div>
              </div>
            </ng-container>
          </div>
          <!-- Scrollable Filters -->
          <div class="argent-grid-header-scrollable" #headerScrollableFilter>
            <div class="argent-grid-header-row" [style.width.px]="getScrollableHeaderWidth()">
              <ng-container *ngFor="let col of getNonPinnedColumns()">
                <div *ngIf="isColumnVisible(col)"
                     class="argent-grid-floating-filter-cell"
                     [style.width.px]="getItemWidth(col)">
                  <div class="floating-filter-container" *ngIf="isFloatingFilterEnabled(col)">
                    <button class="floating-filter-btn" 
                            *ngIf="isSetFilter(col)"
                            [class.active]="hasSetFilterValue(col)"
                            (click)="openSetFilter($event, col)">
                      <span class="filter-label">{{ getFloatingFilterValue(col) || 'All' }}</span>
                      <span class="filter-count" *ngIf="hasSetFilterValue(col)">ðŸ”½ {{ getSetFilterCount(col) }}</span>
                    </button>
                    <ng-container *ngIf="!isSetFilter(col)">
                      <input #filterInput
                             class="floating-filter-input"
                             [type]="getFilterInputType(col)"
                             [value]="getFloatingFilterValue(col)"
                             (input)="onFloatingFilterInput($event, col)"
                             [placeholder]="'Filter...'" />
                      <span class="floating-filter-clear" 
                            *ngIf="hasFilterValue(col, filterInput)"
                            (click)="clearFloatingFilter(col, filterInput)">âœ•</span>
                    </ng-container>
                  </div>
                </div>
              </ng-container>
            </div>
          </div>
          <!-- Right Pinned Filters -->
          <div class="argent-grid-header-pinned-right-container" *ngIf="getRightPinnedColumns().length > 0">
            <ng-container *ngFor="let col of getRightPinnedColumns()">
              <div *ngIf="isColumnVisible(col)"
                   class="argent-grid-floating-filter-cell"
                   [style.width.px]="getItemWidth(col)">
                <div class="floating-filter-container" *ngIf="isFloatingFilterEnabled(col)">
                  <input #filterInput
                         class="floating-filter-input"
                         [type]="getFilterInputType(col)"
                         [value]="getFloatingFilterValue(col)"
                         (input)="onFloatingFilterInput($event, col)"
                         [placeholder]="'Filter...'" />
                  <span class="floating-filter-clear" 
                        *ngIf="hasFilterValue(col, filterInput)"
                        (click)="clearFloatingFilter(col, filterInput)">âœ•</span>
                </div>
              </div>
            </ng-container>
          </div>

          <!-- Vertical Scrollbar Spacer -->
          <div class="argent-grid-header-scrollbar-spacer" 
               *ngIf="scrollbarWidth > 0"
               [style.width.px]="scrollbarWidth">
          </div>
        </div>
      </div>

      <!-- Canvas Layer for Data Viewport -->
      <div class="argent-grid-viewport" #viewport>
        <div class="argent-grid-scroll-spacer" [style.height.px]="totalHeight" [style.width.px]="totalWidth"></div>
        <canvas #gridCanvas class="argent-grid-canvas" (contextmenu)="onCanvasContextMenu($event)"></canvas>
        
        <!-- Cell Editor Overlay -->
        <div class="argent-grid-cell-editor" 
             *ngIf="isEditing"
             [style.top.px]="editorPosition.y"
             [style.left.px]="editorPosition.x"
             [style.width.px]="editorPosition.width"
             [style.height.px]="editorPosition.height"
             (click)="$event.stopPropagation()">
          <input #editorInput
                 type="text"
                 class="argent-grid-editor-input"
                 [value]="editingValue"
                 (input)="onEditorInput($event)"
                 (keydown)="onEditorKeydown($event)"
                 (blur)="onEditorBlur()"
                 autofocus />
        </div>
      </div>
    </div>

    <!-- Side Bar -->
    <div class="argent-grid-side-bar" *ngIf="sideBarVisible" [class.has-active-panel]="!!activeToolPanel">
      <div class="side-bar-buttons">
        <div class="side-bar-button" [class.active]="activeToolPanel === 'columns'" (click)="toggleToolPanel('columns')">
          Columns
        </div>
        <div class="side-bar-button" [class.active]="activeToolPanel === 'filters'" (click)="toggleToolPanel('filters')">
          Filters
        </div>
      </div>
      
      <div class="tool-panel-content" *ngIf="activeToolPanel">
        <div class="columns-tool-panel" *ngIf="activeToolPanel === 'columns'">
          <h3>Columns</h3>
          <div class="column-list" cdkDropList (cdkDropListDropped)="onSidebarColumnDropped($event)">
            <div *ngFor="let col of getAllColumns()" class="column-item" cdkDrag [cdkDragData]="col">
              <span class="column-drag-handle" cdkDragHandle>â ¿</span>
              <input type="checkbox" [checked]="col.visible" (change)="toggleColumnVisibility(col)" />
              <span class="column-label">{{ getHeaderName(col) }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Overlay for loading/no rows -->
  <div class="argent-grid-overlay" *ngIf="showOverlay">
    <ng-content select="[overlay]"></ng-content>
  </div>

  <!-- Menus and Popups -->
  <div class="argent-grid-header-menu" *ngIf="activeHeaderMenu" [style.top.px]="headerMenuPosition.y" [style.left.px]="headerMenuPosition.x" (click)="$event.stopPropagation()">
    <ng-container *ngFor="let item of headerMenuItems">
      <div *ngIf="item.separator" class="menu-divider"></div>
      <div *ngIf="!item.separator" class="menu-item" (click)="!item.disabled && item.action(); !item.subMenu && closeHeaderMenu()">
        <span class="menu-icon" *ngIf="item.icon">{{ item.icon }}</span>
        <span class="menu-text">{{ item.name }}</span>
      </div>
    </ng-container>
  </div>

  <!-- Set Filter Popup -->
  <div *ngIf="activeSetFilter" class="set-filter-popup" [style.left.px]="setFilterPosition.x" [style.top.px]="setFilterPosition.y" (clickOutside)="closeSetFilter()" clickOutside>
    <argent-set-filter [values]="setFilterValues" [valueFormatter]="setFilterValueFormatter" (filterChanged)="onSetFilterChanged($event)"></argent-set-filter>
  </div>
</div>
